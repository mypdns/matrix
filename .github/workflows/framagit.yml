name: Mirror to Framagit
on:
  push:
    branches:
      - '**'

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mirror to framagit (HTTPS with token)
        env:
          FRAMAGIT_URL: https://framagit.org/my-privacy-dns/matrix.git
          FRAMAGIT_TOKEN: ${{ secrets.FRAMAGIT_TOKEN }}
        run: |
          set -e
          # Configure remote with token in URL (token has push access)
          # Format: https://<token>@framagit.org/owner/repo.git
          auth_url="${FRAMAGIT_URL/https:\/\/ /https:\/\/${FRAMAGIT_TOKEN}@}"
          # If the above parameter expansion fails on runner shell, construct explicitly:
          auth_url="https://${FRAMAGIT_TOKEN}@framagit.org/my-privacy-dns/matrix.git"

          git remote remove framagit || true
          git remote add framagit "$auth_url"
          # Push all refs and tags, pruning deleted refs
          git push --prune --mirror framagit
