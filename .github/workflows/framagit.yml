name: Mirror to Framagit

on:
  push:
    branches:
      - '**'
  repository_dispatch:
    types: [shadowwhisperer.updated]

jobs:
  mirror:
    runs-on: ubuntu-latest
    env:
      FRAMAGIT_URL: https://framagit.org/my-privacy-dns/matrix.git
      FRAMAGIT_TOKEN: ${{ secrets.FRAMAGIT_TOKEN }}
    steps:
      - name: Validate repository secrets
        run: |
          set -euo pipefail
          if [ -z "${FRAMAGIT_TOKEN:-}" ]; then
            echo "ERROR: FRAMAGIT_TOKEN is not set." >&2
            exit 1
          fi

      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mirror to framagit (HTTPS with token via netrc)
        run: |
          set -euo pipefail

          echo "Configuring ~/.netrc for framagit.org"
          printf "machine framagit.org login %s password %s\n" "spirillen" "${FRAMAGIT_TOKEN}" > "$HOME/.netrc"
          chmod 600 "$HOME/.netrc"

          echo "Ensuring framagit remote points to $FRAMAGIT_URL"
          git remote remove framagit || true
          git remote add framagit "$FRAMAGIT_URL"

          echo "Remote list:"
          git remote -v

          echo "Performing dry-run push (no changes made)"
          git push --prune --mirror framagit --dry-run

          echo "Performing actual mirror push"
          git push --prune --mirror framagit
